# Cursor Rules - AI Fitting Engine

## 0) Prime Directive (최상위 원칙)
- 사용자가 지시한 **이번 작업의 범위(Scope)** 안에서만 행동한다.
- 범위를 벗어나는 변경(리팩터링/구조 개편/정책 변경)은 **사전 승인 없이 금지**다.
- 특히 **Semantic 재해석/자동 대체(표준키 의미 변경)** 는 절대 금지다.

## 1) Repository Structure (Stable Areas)
- `engine/`: Future center for product logic (incremental migration planned)
- `core/`: Reusable pure logic (measurements, filters, utilities) - DO NOT MOVE YET
- `pipelines/`: Execution pipelines - DO NOT MOVE YET
- `verification/`: Verification runners and tools - DO NOT MOVE YET
- `tests/`: Test suites - DO NOT MOVE YET

## 2) Mandatory Pre-Read (작업 시작 전 필수 확인)
작업 시작 전 아래 문서를 먼저 읽고 준수한다.
1) `docs/ops/cursor_prompt_header.md`
   - "Cursor does / Human does / Output contract / Forbidden actions"를 절대 준수
2) 라운드 목표(있을 때)
   - 우선: `verification/runs/**/ROUND_CHARTER.md`
   - 없으면: `docs/verification/round_charter_template.md`를 기준으로
     사용자에게 “현재 라운드 헌장 파일 경로”를 **1회만** 요청
3) facts 기반 리포트 작성 시 KPI Header 사용
   - `py tools/summarize_facts_kpi.py <facts_summary.json>` 결과를 리포트 상단에 포함

## 3) Facts KPI Header Rule (범위 제한)
- **facts_summary.json이 생성되는 facts-only runner 리포트에 한정**하여 KPI Header를 포함한다.
- facts_summary.json이 없거나 스키마가 다르면:
  - 크래시/중단 금지
  - 가능한 값은 출력하고, 나머지는 N/A로 표기
  - 사유를 리포트/코멘트에 짧게 기록

## 4) PR / Merge Rule (기본값)
- 사용자가 “PR 생성 + merge까지”를 요구한 경우:
  - 브랜치 생성 → 커밋/푸시 → PR 생성 → CI 확인(가능 시) → merge까지 완료한다.
- PR 설명에는 반드시 아래를 포함한다:
  - 변경 파일 목록
  - 재현/스모크 실행 커맨드(있다면)
  - 위험/범위/금지사항 준수 여부 요약(1~3줄)

## 5) Strict Safety Rules (항상 적용)
1) **NO DELETIONS**: `git rm` 금지 (예외가 필요하면 반드시 사용자 승인)
2) **NO LARGE-SCALE FILE MOVES**: `core/`, `pipelines/`, `verification/`, `tests/` 폴더 이동 금지
3) **NO UNREQUESTED REFACTORING**: 대규모 리팩터링 금지 (요청받지 않은 함수/파일 정리 금지)
4) **NO SEMANTIC POLICY DRIFT**: 표준키 정의/정책 문서의 의미를 바꾸는 수정 금지
5) **NO “SMART GUESSING”**: 자동 유사매칭/자동 대체/추측 기반 수정 금지

## 6) Prohibited Modifications (기본 금지 구역)
- 사용자 지시 없이 다음 영역은 수정 금지:
  - `data/`, `models/`, `artifacts/`, `experiments/` (산출물/원천 데이터 영역)
  - `verification/runs/` 등 실행 산출물 폴더(특별 지시 없으면 커밋 금지)
  - legacy 문서의 대규모 재작성(요청 없으면 금지)

## 7) Conditional Scope Lock (문서/운영/DB 최소화 PR일 때만)
사용자가 이번 PR 목적을 아래처럼 명시한 경우에만 적용한다:
- "structure declaration", "operational rules", "DB minimization", "docs-only"

이 경우 추가로:
- **NO CODE LOGIC CHANGES**: 기존 코드 로직 변경 금지(버그 픽스 포함)
- 변경은 문서/DB/설정(예: `.cursorrules`) 위주로만 수행

## 8) Allowed Modification Scope (ONLY IF the user explicitly says so)
사용자가 “이번 PR에서 허용”이라고 명시한 경우에만 아래 파일들은 자유 수정 가능:
- `README.md`
- `SYNC_HUB.md`
- `DB_GUIDE.md`
- `.cursorrules`
- `db/schema.sql`
- `tools/db_upsert.py`
- `engine/README.md`

## 9) Round Postprocessing Rule (필수)
- 라운드 실행(out_dir 생성) 후 반드시 `py tools/postprocess_round.py --run_dir <out_dir>`를 실행해 KPI/DIFF/CHARTER를 마감한다.
- 이 규칙은 프로젝트 헌법으로, 모든 라운드 실행에 적용된다.

## 10) Purpose (Template)
- 이 규칙의 목적은:
  - 프로젝트 구조 안정성 유지
  - 라운드 기반 실행(ROUND_CHARTER) 일관성 확보
  - facts KPI Header를 통한 분석 비용 절감
  - 조용한 오답(추측/자동대체/정책 드리프트) 방지
  - 라운드 후처리 자동화를 통한 운영 일관성 확보

## 11) Ops Plane (참고)
- Guardrails: [`docs/ops/GUARDRAILS.md`](docs/ops/GUARDRAILS.md) - Import 경계 검사 및 구조 오염 방지
- Backfill Policy: [`docs/ops/BACKFILL_POLICY.md`](docs/ops/BACKFILL_POLICY.md) - Tier 0/1/2 백필 정책

## 12) Multi-Agent Roles (Agent Contract)
- **Cursor**: Mainline work, PR/merge authority (CI green only)
- **Claude Code (claude.ai/code)**: Large scans/refactors, PR/merge authority (CI green only), keep PRs small
- **Anti-gravity**: NO PR, NO merge; isolated fitting sandbox work only; MUST NOT edit SSoT/ops docs
- **SSoT Touch Lock (during parallel/refactor)**:
  - SSoT docs (SYNC_HUB.md, docs/sync/CURRENT_STATE.md, docs/ops/INDEX.md, docs/ops/OPS_PLANE.md, docs/architecture/LAYERS_v1.md, docs/architecture/DoD_CHECKLISTS_v1.md) can ONLY be changed in dedicated docs-only PRs
  - Exception: docs-only PR explicitly labeled as such
- **Round Notes (parallel mode)**: New files only: `docs/ops/rounds/roundXX_<module>_<agent>.md`; never edit shared roundXX.md in parallel mode
