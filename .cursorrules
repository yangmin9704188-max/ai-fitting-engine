# Cursor Rules - AI Fitting Engine
# Canon Lock Version: 2026-01-29

"모든 구조적 판단은 docs/ops/DIRECTORY_CHARTER_v1.md를 따른다. Sanctuary 수정 시 반드시 사용자 승인을 득할 것."

## 1. Golden Sources (SSoT)

All cross-module interfaces and policies are canonical in these files. Do not duplicate rules elsewhere.

| Document | Path | Purpose |
|----------|------|---------|
| Interface Ledger | `contracts/interface_ledger_v0.md` | Cross-module artifact interface (Path/Name/Version/NaN/Warnings) |
| Port Checklist | `contracts/port_readiness_checklist_v0.md` | fitting_lab → main port procedure |
| Port Template | `contracts/port_event_note_template_v0.md` | Port event recording |
| GUARDRAILS | `docs/ops/GUARDRAILS.md` | Import boundary rules |

**Rule**: When uncertain, READ the SSoT file first. Do not infer or guess.

---

## 2. Absolute Prohibitions

### 2.1 Structural Changes (main repo)
- ❌ `git rm` — file deletion forbidden without explicit user approval
- ❌ `git mv` — folder/file moves forbidden (especially `core/`, `pipelines/`, `verification/`, `tests/`)
- ❌ Large-scale refactoring without explicit request

### 2.2 Semantic Drift
- ❌ Modifying `contracts/interface_ledger_v0.md` directly (agents output to `artifacts/interface_ledger_rows.jsonl` only)
- ❌ Changing standard key definitions or policy meanings
- ❌ "Smart guessing" — automatic similar-matching, auto-substitution, guess-based modifications

### 2.3 Facts-Only Violation
- ❌ PASS/FAIL judgments in validation output
- ❌ Threshold-based decisions
- ❌ Data clamping to improve metrics
- ❌ Dropping NaN values to inflate coverage

### 2.4 Legacy Document Rewrite
- ❌ Content rewriting of legacy docs (stamp-only editing allowed)
- ❌ Applying LEGACY stamps to `contracts/**`, `modules/**`, `specs/**` (active code paths)

---

## 3. Canonical Policies

### 3.1 Name=B (Filename Convention)
| Module | Input | Output |
|--------|-------|--------|
| body | manifest, mesh | `facts_summary.json` |
| fitting | body's `facts_summary.json` | `fitting_facts_summary.json` |

**Rule**: fitting module MUST output `fitting_facts_summary.json`, NOT `facts_summary.json`.

### 3.2 Version=C (4 Keys Always)
All cross-module artifacts MUST have these 4 keys in provenance:
```
snapshot_version, semantic_version, geometry_impl_version, dataset_version
```
- Unknown value: `"UNSPECIFIED"`
- Warning code: `VERSION_KEY_UNSPECIFIED`

### 3.3 Path=C (REL Base)
- Canonical REL base: `manifest_dir` (directory containing manifest)
- Legacy `run_dir` allowed only with explicit `"path_base": "run_dir"` in provenance

### 3.4 NaN/Inf Serialization
- NaN → `null` (no warning)
- Inf → `null` + warning `INF_SERIALIZED_AS_NULL`
- -Inf → `null` + warning `NEG_INF_SERIALIZED_AS_NULL`

### 3.5 Warnings Format (cross-module)
```json
{
  "warnings": {
    "<CODE>": {
      "count": 5,
      "sample_messages": ["msg1", "msg2", ...],
      "truncated": true
    }
  }
}
```

### 3.6 Round Policy
- Lane format: `<module>/<lane_id>` (e.g., `body/geo_v0_s1`)
- Milestone format: `M<NN>_<tag>` (e.g., `M01_baseline`)
- Round ID: `<lane_slug>__<milestone_id>__r<NN>`
- New round docs: `docs/ops/rounds/<lane_slug>/<milestone_id>/round_<NN>.md`

### 3.7 Legacy Stamp Format
For superseded documents (header line 1):
```
> ⚠️ STATUS: LEGACY NAMING
> New rounds use folder-split format: docs/ops/rounds/<lane_slug>/<milestone_id>/round_<NN>.md
> This file preserved for history.
---
```

---

## 4. Change Process

### 4.1 Branch → PR → Merge Flow
1. Create feature branch from `main`
2. Make changes (minimal scope)
3. `git status` / `git diff --stat` before commit
4. Commit with descriptive message
5. Push and create PR
6. Wait for CI green
7. Merge (squash or fast-forward)

### 4.2 PR Description Requirements
- Changed file list
- Reproduction/smoke command (if applicable)
- Scope compliance summary (1-3 lines)

### 4.3 Round Postprocessing (mandatory)
After any round execution:
```bash
python tools/postprocess_round.py --current_run_dir <out_dir>
```

---

## 5. Evidence-First (DoD Priority)

Definition of Done (priority order):
1. **File path exists** — output files are created at expected locations
2. **Schema valid** — JSON matches expected schema
3. **Provenance complete** — 4 version keys present
4. **Warnings recorded** — any anomalies captured in warnings object

---

## 6. Multi-Agent Roles

| Agent | PR/Merge | Scope |
|-------|----------|-------|
| Cursor | ✅ (CI green) | Mainline work |
| Claude Code | ✅ (CI green) | Large scans, keep PRs small |
| Anti-gravity | ❌ | Isolated fitting_lab sandbox only; MUST NOT edit SSoT/ops docs |

### SSoT Touch Lock (parallel mode)
During parallel work, these files require dedicated docs-only PR:
- `SYNC_HUB.md`, `docs/sync/CURRENT_STATE.md`
- `docs/ops/INDEX.md`, `docs/architecture/LAYERS_v1.md`
- `contracts/interface_ledger_v0.md`

---

## 7. When Uncertain

1. **READ the SSoT file** (`contracts/interface_ledger_v0.md`)
2. **Verify file paths exist** before referencing
3. **Ask the user** rather than inferring
4. **Do NOT auto-substitute** similar-looking values
5. **Do NOT extend scope** beyond the current task

**Golden Rule**: If a policy isn't in the SSoT, it doesn't exist. Do not invent rules.

---

## 8. Quick Reference

```
SSoT:           contracts/interface_ledger_v0.md
Port SSoT:      contracts/port_readiness_checklist_v0.md
Fitting output: fitting_facts_summary.json (NOT facts_summary.json)
Version keys:   snapshot_version, semantic_version, geometry_impl_version, dataset_version
Unknown value:  "UNSPECIFIED"
NaN/Inf:        serialize as null
REL base:       manifest_dir
```
