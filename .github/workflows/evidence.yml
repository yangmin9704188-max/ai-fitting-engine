name: evidence-check

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  validate-evidence:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if infra-only PR
        id: check_infra
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          else
            # For push events, compare with previous commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Infra-only paths (skip evidence check)
          INFRA_PATTERNS=(
            ".github/workflows/"
            "docs/"
            "tools/"  # Only infra tools, not ML pipelines
          )
          
          # ML-related paths (require evidence check)
          ML_PATTERNS=(
            "artifacts/"
            "core/pose_policy"
            "core/measurements"
            "core/policy"
            "pipelines/"  # ML pipelines
            "verification/"
            "core/smart_mapper"
          )
          
          # Check if any ML-related files changed
          ML_CHANGED=false
          for pattern in "${ML_PATTERNS[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "^${pattern}\|/${pattern}"; then
              ML_CHANGED=true
              echo "ML-related file changed: $pattern"
              break
            fi
          done
          
          # Check if only infra files changed
          INFRA_ONLY=true
          if [ "$ML_CHANGED" = "true" ]; then
            INFRA_ONLY=false
          else
            # Verify all changed files are infra-only
            while IFS= read -r file; do
              if [ -z "$file" ]; then
                continue
              fi
              IS_INFRA=false
              for pattern in "${INFRA_PATTERNS[@]}"; do
                if echo "$file" | grep -q "^${pattern}\|/${pattern}"; then
                  IS_INFRA=true
                  break
                fi
              done
              # If file is not infra and not in .gitignore/common files, require evidence
              if [ "$IS_INFRA" = "false" ] && ! echo "$file" | grep -qE "^\.gitignore|^README|\.md$"; then
                INFRA_ONLY=false
                echo "Non-infra file changed: $file"
                break
              fi
            done <<< "$CHANGED_FILES"
          fi
          
          if [ "$INFRA_ONLY" = "true" ]; then
            echo "IS_INFRA_ONLY=true" >> $GITHUB_OUTPUT
            echo "Skipping evidence validation for infra-only changes."
          else
            echo "IS_INFRA_ONLY=false" >> $GITHUB_OUTPUT
            echo "ML-related or mixed changes detected. Evidence validation required."
          fi

      - name: Set up Python
        if: steps.check_infra.outputs.IS_INFRA_ONLY != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        if: steps.check_infra.outputs.IS_INFRA_ONLY != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate observation & manifest (if present)
        if: steps.check_infra.outputs.IS_INFRA_ONLY != 'true'
        run: |
          # Guard: Skip if infra-only (double-check)
          IS_INFRA_ONLY="${{ steps.check_infra.outputs.IS_INFRA_ONLY }}"
          if [ "$IS_INFRA_ONLY" = "true" ]; then
            echo "Skipping evidence validation for infra-only changes."
            exit 0
          fi
          
          if [ -f logs/observation.md ]; then
            python tools/validate_observation.py --require-manifest
          else
            echo "No observation.md found. Skipping evidence validation."
          fi

      - name: Ensure pending_review exists (if required)
        if: steps.check_infra.outputs.IS_INFRA_ONLY != 'true'
        run: |
          if [ -f pending_review.json ]; then
            echo "pending_review.json found."
          else
            echo "No pending_review.json. This is allowed for infra PRs."
          fi

      - name: Skip evidence validation for infra-only PRs
        if: steps.check_infra.outputs.IS_INFRA_ONLY == 'true'
        run: |
          echo "Skipping evidence validation for infra-only changes."
          echo "Changed files are limited to: .github/workflows/, docs/, tools/ (infra)"
          echo "No ML-related changes detected. Evidence validation not required."
