name: evidence-check

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  validate-evidence:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if infra-only PR
        id: check_infra
        run: |
          # Get changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
            HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          else
            # For push events, compare with previous commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          fi
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Allowlist: only these paths are considered infra-only
          # All changed files must match one of these patterns
          ALLOWLIST_PATTERNS=(
            "^\.github/workflows/"
            "^docs/"
          )
          
          # Check if ALL changed files are in allowlist
          INFRA_ONLY=true
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            MATCHED=false
            for pattern in "${ALLOWLIST_PATTERNS[@]}"; do
              if echo "$file" | grep -qE "$pattern"; then
                MATCHED=true
                break
              fi
            done
            if [ "$MATCHED" = "false" ]; then
              INFRA_ONLY=false
              echo "Non-infra file changed (not in allowlist): $file"
              break
            fi
          done <<< "$CHANGED_FILES"
          
          if [ "$INFRA_ONLY" = "true" ]; then
            echo "IS_INFRA_ONLY=true" >> $GITHUB_OUTPUT
            echo "Skipping evidence validation for infra-only changes (.github/workflows/ or docs/ only)."
          else
            echo "IS_INFRA_ONLY=false" >> $GITHUB_OUTPUT
            echo "Non-infra files changed. Evidence validation required."
          fi

      - name: Set up Python
        if: steps.check_infra.outputs.IS_INFRA_ONLY != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        if: steps.check_infra.outputs.IS_INFRA_ONLY != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate observation & manifest (if present)
        if: steps.check_infra.outputs.IS_INFRA_ONLY != 'true'
        env:
          IS_INFRA_ONLY: ${{ steps.check_infra.outputs.IS_INFRA_ONLY }}
        run: |
          # Guard: Skip if infra-only (double-check using env var)
          echo "IS_INFRA_ONLY=${IS_INFRA_ONLY}"
          if [ "${IS_INFRA_ONLY}" = "true" ]; then
            echo "Skipping evidence validation for infra-only changes."
            exit 0
          fi
          
          if [ -f logs/observation.md ]; then
            python tools/validate_observation.py --require-manifest
          else
            echo "No observation.md found. Skipping evidence validation."
          fi

      - name: Ensure pending_review exists (if required)
        if: steps.check_infra.outputs.IS_INFRA_ONLY != 'true'
        run: |
          if [ -f pending_review.json ]; then
            echo "pending_review.json found."
          else
            echo "No pending_review.json. This is allowed for infra PRs."
          fi

      - name: Skip evidence validation for infra-only PRs
        if: steps.check_infra.outputs.IS_INFRA_ONLY == 'true'
        run: |
          echo "Skipping evidence validation for infra-only changes."
          echo "Changed files are limited to: .github/workflows/, docs/, tools/ (infra)"
          echo "No ML-related changes detected. Evidence validation not required."
